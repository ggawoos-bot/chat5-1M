/**
 * 질문별 관련 컨텍스트 선택 서비스
 * AI 기반 질문 분석과 의미적 유사도를 통한 정확한 컨텍스트 선택
 */

import { GoogleGenAI } from '@google/genai';
import { Chunk, QuestionAnalysis } from '../types';

// API 키는 런타임에 동적으로 로딩 (브라우저 로딩 타이밍 문제 해결)

export class QuestionAnalyzer {
  private static currentKeyIndex: number = 0; // API 키 로테이션을 위한 인덱스
  private ai: GoogleGenAI | null = null;

  constructor() {
    console.log('QuestionAnalyzer 초기화 중...');
    
    // 런타임에 API 키 확인
    const apiKeys = this.getApiKeys();
    console.log(`사용 가능한 API 키 개수: ${apiKeys.length}`);
    
    if (apiKeys.length > 0) {
      console.log('API 키 로테이션 시스템 활성화');
      console.log('매 질문 분석마다 다른 API 키를 사용합니다.');
      // 하이브리드 방식에서는 초기화 시 AI 인스턴스를 생성하지 않음
      // 매 질문 분석마다 새로운 키로 인스턴스 생성
    } else {
      console.warn('사용 가능한 API 키가 없습니다.');
      console.log('환경변수 확인:');
      console.log('VITE_GEMINI_API_KEY:', import.meta.env.VITE_GEMINI_API_KEY ? '설정됨' : '설정되지 않음');
      console.log('VITE_GEMINI_API_KEY_1:', import.meta.env.VITE_GEMINI_API_KEY_1 ? '설정됨' : '설정되지 않음');
      console.log('VITE_GEMINI_API_KEY_2:', import.meta.env.VITE_GEMINI_API_KEY_2 ? '설정됨' : '설정되지 않음');
    }
  }

  // ✅ 런타임에 API 키를 동적으로 가져오는 메서드 (폴백 메커니즘 포함)
  private getApiKeys(): string[] {
    const keys = [
      import.meta.env.VITE_GEMINI_API_KEY || '',
      import.meta.env.VITE_GEMINI_API_KEY_1 || '',
      import.meta.env.VITE_GEMINI_API_KEY_2 || '',
    ].filter(key => key && key !== 'YOUR_GEMINI_API_KEY_HERE' && key !== '');
    
    console.log('QuestionAnalyzer 런타임 API 키 로딩:', keys.map(k => k ? k.substring(0, 10) + '...' : 'undefined'));
    console.log(`QuestionAnalyzer: 총 ${keys.length}개의 유효한 API 키 발견`);
    return keys;
  }

  // 다음 사용 가능한 API 키를 가져오는 메서드 (런타임 동적 로딩)
  private getNextAvailableKey(): string | null {
    const API_KEYS = this.getApiKeys(); // 런타임에 동적 로딩
    
    if (API_KEYS.length === 0) {
      console.warn('런타임에 API 키를 찾을 수 없습니다.');
      return null;
    }
    
    // currentKeyIndex 초기화 체크
    if (isNaN(QuestionAnalyzer.currentKeyIndex)) {
      QuestionAnalyzer.currentKeyIndex = 0;
    }
    
    const selectedKey = API_KEYS[QuestionAnalyzer.currentKeyIndex % API_KEYS.length];
    const keyIndex = QuestionAnalyzer.currentKeyIndex % API_KEYS.length;
    
    // 다음 호출을 위해 인덱스 증가
    QuestionAnalyzer.currentKeyIndex = (QuestionAnalyzer.currentKeyIndex + 1) % API_KEYS.length;
    
    console.log(`QuestionAnalyzer API 키 선택: ${selectedKey.substring(0, 10)}... (인덱스: ${keyIndex})`);
    
    return selectedKey;
  }

  /**
   * AI를 사용한 질문 분석 (하이브리드 방식: 매번 새로운 API 키 사용)
   */
  async analyzeQuestion(question: string): Promise<QuestionAnalysis> {
    // 매 질문 분석마다 새로운 API 키 선택
    const selectedApiKey = this.getNextAvailableKey();
    if (!selectedApiKey) {
      console.warn('사용 가능한 API 키가 없습니다. 기본 분석을 사용합니다.');
      return this.basicAnalysis(question);
    }

    console.log(`질문 분석 - API 키: ${selectedApiKey.substring(0, 10)}...`);

    try {
      // 새로운 AI 인스턴스 생성 (선택된 키로)
      const ai = new GoogleGenAI({ apiKey: selectedApiKey });
      const model = ai.getGenerativeModel({ model: 'gemini-2.5-flash' });

      const analysisPrompt = `
다음 질문을 분석하여 JSON 형태로 답변해주세요:

질문: "${question}"

다음 형식으로 분석해주세요:
{
  "intent": "질문의 의도 (예: 금연구역 지정 절차 문의, 규정 내용 확인 등)",
  "keywords": ["핵심 키워드 배열"],
  "category": "질문 카테고리 (definition/procedure/regulation/comparison/analysis/general)",
  "complexity": "복잡도 (simple/medium/complex)",
  "entities": ["질문에서 언급된 구체적 개체들"],
  "context": "질문의 맥락 설명"
}

분석 기준:
- category: definition(정의), procedure(절차), regulation(규정), comparison(비교), analysis(분석), general(일반)
- complexity: simple(단순), medium(중간), complex(복잡)
- keywords: 질문의 핵심을 나타내는 중요한 단어들
- entities: 구체적인 명사, 기관명, 법령명 등
`;

      // 새로운 AI 인스턴스로 API 호출
      const result = await model.generateContent(analysisPrompt);
      const response = await result.response;
      const text = response.text();
      
      console.log(`질문 분석 완료 - 사용된 키: ${selectedApiKey.substring(0, 10)}...`);
      
      // JSON 파싱 시도
      try {
        const analysis = JSON.parse(text);
        return {
          intent: analysis.intent || '일반 문의',
          keywords: analysis.keywords || [],
          category: (analysis.category as QuestionAnalysis['category']) || 'general',
          complexity: (analysis.complexity as QuestionAnalysis['complexity']) || 'simple',
          entities: analysis.entities || [],
          context: analysis.context || ''
        };
      } catch (parseError) {
        console.warn('JSON 파싱 실패, 기본 분석 사용:', parseError);
        return this.basicAnalysis(question);
      }
      
    } catch (error) {
      console.error('질문 분석 중 오류:', error);
      return this.basicAnalysis(question);
    }
  }

  /**
   * 기본 질문 분석 (AI 없이)
   */
  private basicAnalysis(question: string): QuestionAnalysis {
    const keywords = this.extractKeywords(question);
    const category = this.classifyCategory(question);
    const complexity = this.assessComplexity(question);
    const entities = this.extractEntities(question);

    return {
      intent: this.generateIntent(question, keywords),
      keywords,
      category,
      complexity,
      entities,
      context: question
    };
  }

  /**
   * AI 응답 파싱
   */
  private parseAnalysisResponse(responseText: string): QuestionAnalysis {
    try {
      // JSON 파싱 시도
      const analysis = JSON.parse(responseText);
        return {
        intent: analysis.intent || '일반 문의',
          keywords: analysis.keywords || [],
          category: analysis.category || 'general',
        complexity: analysis.complexity || 'simple',
          entities: analysis.entities || [],
          context: analysis.context || ''
        };
    } catch (error) {
      console.warn('AI 응답 파싱 실패, 기본 분석 사용:', error);
      return this.basicAnalysis('');
    }
  }

  /**
   * 키워드 추출 (하이브리드 방식: 하드코딩 + 동적) - 공동주택 우선 처리
   */
  private extractKeywords(question: string): string[] {
    // 🆕 공동주택 관련 키워드 우선 체크
    const apartmentKeywords = [
      '공동주택', '아파트', '오피스텔', '빌라', '연립주택', '다세대주택', '집합주택',
      '필로티', '기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간',
      '공용공간', '공용시설', '공동시설', '공용구역', '공동구역', '공용부지',
      '복도', '통로', '복도공간', '통로공간', '복도구역', '통로구역',
      '계단', '계단실', '계단공간', '계단구역', '승강계단', '비상계단',
      '엘리베이터', '승강기', '엘리베이터실', '승강기실', '승강기구역',
      '지하주차장', '지하주차공간', '지하주차구역', '지하주차시설',
      '세대주', '입주자', '거주자', '세대원', '입주민', '거주민', '세대',
      '관리사무소', '관리사', '관리업체', '관리회사', '관리단체', '관리조합',
      '동의', '투표', '동의서', '투표서', '승인서', '합의서', '찬성', '반대',
      '지정신청', '해제신청', '신청서', '신청절차', '신청방법', '신청기간'
    ];
    
    const hasApartmentContext = apartmentKeywords.some(keyword => 
      question.toLowerCase().includes(keyword.toLowerCase())
    );
    
    if (hasApartmentContext) {
      // 공동주택 관련 질문에 높은 가중치 부여
      console.log('공동주택 관련 질문 감지 - 특별 처리 적용');
      return [...apartmentKeywords, ...this.extractOtherKeywords(question)];
    }
    
    // 1. 하드코딩된 핵심 키워드 (대폭 확장)
    const hardcodedKeywords = [
      // 기본 금연 관련 키워드
      '금연', '금연구역', '건강증진', '시행령', '시행규칙', '지정', '관리', '업무', '지침',
      '서비스', '통합', '사업', '지원', '규정', '법률', '조항', '항목', '절차', '방법',
      '기준', '요건', '조건', '제한', '신고', '신청', '처리', '심사', '승인', '허가',
      '등록', '변경', '취소', '정지', '폐지', '해제', '위반', '과태료', '벌금', '처벌',
      '제재', '조치', '시설', '장소', '구역', '지역', '범위', '대상', '기관', '단체',
      '조직', '협회', '연합', '연합회', '담당', '책임', '의무', '권한', '기능', '역할',
      '교육', '홍보', '점검', '통계', '분석', '개선', '지원', '협력', '평가', '운영',
      '개발', '보안', '업데이트', '장애', '대응', '보고', '제출', '접수', '심의', '검토',
      
      // 어린이 관련 키워드
      '어린이집', '유치원', '학교', '초등학교', '중학교', '고등학교', '대학교',
      '보육', '교육', '학생', '어린이', '청소년', '아동', '영유아', '영유아보육',
      '유아교육', '보육시설', '교육시설', '학원', '어린이보호', '아동보호',
      
      // 🆕 공동주택 관련 키워드 (대폭 확장)
      '공동주택', '아파트', '오피스텔', '빌라', '연립주택', '다세대주택', '집합주택',
      '주거시설', '주거용건물', '공동주거', '공동거주', '공동생활', '공동거주시설',
      '필로티', '기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간',
      '공용공간', '공용시설', '공동시설', '공용구역', '공동구역', '공용부지',
      '복도', '통로', '복도공간', '통로공간', '복도구역', '통로구역',
      '계단', '계단실', '계단공간', '계단구역', '승강계단', '비상계단',
      '엘리베이터', '승강기', '엘리베이터실', '승강기실', '승강기구역',
      '지하주차장', '지하주차공간', '지하주차구역', '지하주차시설',
      '세대주', '입주자', '거주자', '세대원', '입주민', '거주민', '세대',
      '관리사무소', '관리사', '관리업체', '관리회사', '관리단체', '관리조합',
      '입주자대표', '세대주대표', '관리위원회', '입주자회의', '세대주회의',
      '동의', '투표', '동의서', '투표서', '승인서', '합의서', '찬성', '반대',
      '지정신청', '해제신청', '신청서', '신청절차', '신청방법', '신청기간',
      '신청자격', '신청요건', '신청조건', '신청서류', '신청비용', '신청수수료',
      '지정절차', '해제절차', '지정방법', '해제방법', '지정기간', '해제기간',
      '지정요건', '해제요건', '지정조건', '해제조건', '지정서류', '해제서류',
      '지정비용', '해제비용', '지정수수료', '해제수수료', '지정수수료',
      '지정고시', '해제고시', '지정공고', '해제공고', '지정알림', '해제알림',
      '지정안내', '해제안내', '지정표지', '해제표지', '지정안내표지', '해제안내표지',
      '지정번호', '해제번호', '지정코드', '해제코드', '지정ID', '해제ID',
      '지정일', '해제일', '지정시작일', '해제시작일', '지정종료일', '해제종료일',
      '지정유효기간', '해제유효기간', '지정만료일', '해제만료일',
      '지정갱신', '해제갱신', '지정연장', '해제연장', '지정재신청', '해제재신청',
      '지정변경', '해제변경', '지정수정', '해제수정', '지정보완', '해제보완',
      '지정취소', '해제취소', '지정철회', '해제철회', '지정무효', '해제무효',
      '지정거부', '해제거부', '지정반려', '해제반려', '지정보류', '해제보류',
      '지정보류', '해제보류', '지정보류', '해제보류', '지정보류', '해제보류',
      
      // 🆕 금연구역 관련 상세 키워드
      '금연구역', '금연지역', '금연장소', '금연공간', '금연시설', '금연건물',
      '금연실', '흡연실', '흡연구역', '흡연지역', '흡연장소', '흡연공간',
      '흡연시설', '흡연건물', '흡연부스', '흡연구역', '흡연공간', '흡연실내',
      '흡연실외', '실내흡연', '실외흡연', '옥외흡연', '옥상흡연', '베란다흡연',
      '테라스흡연', '발코니흡연', '복도흡연', '계단흡연', '엘리베이터흡연',
      '지하주차장흡연', '필로티흡연', '공용공간흡연', '공동공간흡연',
      '간접흡연', '직접흡연', '2차흡연', '3차흡연', '수동흡연', '자동흡연',
      '담배연기', '담배냄새', '담배독성', '담배해독', '담배독소', '담배독성물질',
      '니코틴', '타르', '일산화탄소', 'CO', '니코틴중독', '담배중독',
      '금연치료', '금연상담', '금연지원', '금연프로그램', '금연교육',
      '금연홍보', '금연캠페인', '금연운동', '금연정책', '금연법', '금연조례',
      '금연규정', '금연지침', '금연가이드', '금연매뉴얼', '금연안내',
      '금연표지', '금연안내표지', '금연표시', '금연경고', '금연주의',
      '금연금지', '금연금지표지', '금연금지표시', '금연금지안내',
      '금연신고', '금연신고센터', '금연신고전화', '금연신고번호',
      '금연단속', '금연지도', '금연점검', '금연모니터링', '금연감시',
      '금연위반', '금연위반자', '금연위반행위', '금연위반사항',
      '금연과태료', '금연벌금', '금연처벌', '금연제재', '금연조치',
      '금연경고', '금연주의', '금연훈계', '금연교육', '금연상담',
      '금연치료', '금연프로그램', '금연지원', '금연도움', '금연상담센터',
      '금연치료센터', '금연지원센터', '금연상담전화', '금연치료전화',
      '금연지원전화', '금연상담번호', '금연치료번호', '금연지원번호',
      
      // 🆕 법령 관련 상세 키워드
      '국민건강증진법', '건강증진법', '국민건강법', '건강법', '금연법',
      '국민건강증진법시행령', '건강증진법시행령', '국민건강법시행령',
      '국민건강증진법시행규칙', '건강증진법시행규칙', '국민건강법시행규칙',
      '질서위반행위규제법', '질서위반법', '위반행위법', '규제법',
      '질서위반행위규제법시행령', '질서위반법시행령', '위반행위법시행령',
      '주택법', '주거법', '주택관리법', '공동주택관리법', '아파트관리법',
      '영유아보육법', '보육법', '어린이보육법', '아동보육법',
      '유아교육법', '유치원법', '어린이교육법', '아동교육법',
      '초중등교육법', '학교법', '교육법', '학생교육법',
      '공중위생관리법', '위생법', '공중위생법', '위생관리법',
      '게임산업진흥법', '게임법', '게임산업법', '게임진흥법',
      '식품위생법', '식품법', '식품안전법', '식품관리법',
      '청소년보호법', '청소년법', '청소년보호관리법', '청소년관리법',
      '여객자동차운수사업법', '운수법', '여객운수법', '자동차운수법',
      '체육시설설치이용법', '체육법', '체육시설법', '체육관리법',
      '사회복지법', '복지법', '사회복지서비스법', '복지서비스법',
      '목욕장법', '목욕법', '목욕시설법', '목욕관리법',
      '고속국도법', '고속도로법', '국도법', '도로법',
      
      // 🆕 시설 관련 상세 키워드
      '의료기관', '병원', '의원', '클리닉', '보건소', '보건지소', '보건진료소',
      '공공기관', '정부기관', '행정기관', '지방자치단체', '시청', '구청', '군청',
      '대중교통수단', '버스', '지하철', '기차', '택시', '버스정류소', '지하철역',
      '택시승강장', '버스승강장', '기차역', '공항', '항만', '터미널',
      '상업시설', '상점', '마트', '백화점', '시장', '상가', '상업지구',
      '업무시설', '사무실', '오피스', '사무동', '업무동', '사무건물',
      '문화시설', '도서관', '박물관', '미술관', '극장', '영화관', '문화센터',
      '체육시설', '체육관', '수영장', '헬스장', '체육센터', '운동장', '경기장',
      '숙박시설', '호텔', '펜션', '모텔', '게스트하우스', '여관', '여인숙',
      '종교시설', '교회', '절', '성당', '사원', '교당', '성전', '법당',
      '금융시설', '은행', '보험', '증권', '금융기관', '금융센터', '금융지점',
      '음식점', '식당', '카페', '다방', '찻집', '휴게음식점', '일반음식점',
      '제과점', '빵집', '과자점', '제과업소', '제과영업소',
      '식품자동판매기', '자판기', '음료자판기', '식품자판기', '자동판매기',
      '만화대여업소', '만화방', '만화점', '만화대여점', '만화대여소',
      '고속국도휴게시설', '휴게소', '고속도로휴게소', '국도휴게소', '도로휴게소',
      '고속국도부속시설', '고속도로부속시설', '국도부속시설', '도로부속시설',
      
      // 🆕 공간 및 구조 관련 키워드
      '실내', '실외', '옥상', '옥외', '지하', '지상', '층', '층수', '고층', '저층',
      '베란다', '테라스', '발코니', '로프트', '다락', '다락방', '다락층',
      '지붕', '천장', '바닥', '벽', '문', '창문', '유리', '유리창',
      '출입구', '입구', '출구', '문간', '현관', '로비', '홀', '대기실',
      '화장실', '변소', '욕실', '샤워실', '목욕탕', '사우나', '찜질방',
      '주방', '부엌', '조리실', '식당', '식사실', '거실', '침실', '방',
      '서재', '책방', '공부방', '학습실', '도서실', '독서실', '열람실',
      '창고', '보관실', '저장실', '물품보관실', '기계실', '설비실',
      '전기실', '전기설비실', '전기기계실', '전기장치실', '전기시설실',
      '냉난방실', '보일러실', '난방실', '냉방실', '에어컨실', '냉난방기실',
      '급수실', '급수설비실', '급수기실', '급수장치실', '급수시설실',
      '배수실', '배수설비실', '배수기실', '배수장치실', '배수시설실',
      '환기실', '환기설비실', '환기기실', '환기장치실', '환기시설실',
      '소화실', '소화설비실', '소화기실', '소화장치실', '소화시설실',
      '비상실', '비상구', '비상출입구', '비상문', '비상통로', '비상계단',
      '안전실', '안전구', '안전출입구', '안전문', '안전통로', '안전계단',
      '대피실', '대피구', '대피출입구', '대피문', '대피통로', '대피계단',
      '피난실', '피난구', '피난출입구', '피난문', '피난통로', '피난계단',
      
      // 🆕 거리 및 측정 관련 키워드
      '미터', 'm', '센티미터', 'cm', '밀리미터', 'mm', '킬로미터', 'km',
      '거리', '간격', '폭', '너비', '길이', '높이', '깊이', '두께', '직경',
      '반경', '지름', '둘레', '둘레길이', '둘레거리', '둘레간격',
      '경계', '경계선', '경계면', '경계구역', '경계지역', '경계범위',
      '시설경계', '건물경계', '대지경계', '부지경계', '구역경계',
      '시설경계선', '건물경계선', '대지경계선', '부지경계선', '구역경계선',
      '시설경계면', '건물경계면', '대지경계면', '부지경계면', '구역경계면',
      '시설경계구역', '건물경계구역', '대지경계구역', '부지경계구역', '구역경계구역',
      '시설경계지역', '건물경계지역', '대지경계지역', '부지경계지역', '구역경계지역',
      '시설경계범위', '건물경계범위', '대지경계범위', '부지경계범위', '구역경계범위',
      '10미터', '10m', '30미터', '30m', '50미터', '50m', '100미터', '100m',
      '10미터이내', '10m이내', '30미터이내', '30m이내', '50미터이내', '50m이내',
      '10미터이하', '10m이하', '30미터이하', '30m이하', '50미터이하', '50m이하',
      '10미터미만', '10m미만', '30미터미만', '30m미만', '50미터미만', '50m미만',
      '10미터초과', '10m초과', '30미터초과', '30m초과', '50미터초과', '50m초과',
      '10미터이상', '10m이상', '30미터이상', '30m이상', '50미터이상', '50m이상',
      
      // 🆕 시간 및 기간 관련 키워드
      '일', '일자', '날짜', '날', '요일', '월', '월일', '년', '년도', '연도',
      '시간', '시', '분', '초', '오전', '오후', '새벽', '밤', '낮', '저녁',
      '기간', '기한', '마감', '종료', '시작', '개시', '시행', '실시', '적용',
      '유효', '유효기간', '유효기한', '유효마감', '유효종료', '유효시작',
      '만료', '만료일', '만료기간', '만료기한', '만료마감', '만료종료',
      '갱신', '연장', '재신청', '재등록', '재지정', '재승인', '재허가',
      '변경', '수정', '보완', '추가', '삭제', '제거', '취소', '철회', '무효',
      '거부', '반려', '보류', '대기', '심사중', '검토중', '처리중', '진행중',
      
      // 🆕 문서 및 서류 관련 키워드
      '문서', '서류', '자료', '파일', '기록', '보고서', '신고서', '신청서',
      '동의서', '승인서', '허가서', '등록서', '변경서', '취소서', '해제서',
      '고시문', '공고문', '알림문', '안내문', '지침문', '가이드문', '매뉴얼문',
      '표지', '안내표지', '경고표지', '주의표지', '금지표지', '금연표지',
      '스티커', '라벨', '태그', '표시', '표시판', '안내판', '경고판', '주의판',
      '금지판', '금연판', '금연안내판', '금연경고판', '금연주의판', '금연금지판',
      '도면', '설계도', '평면도', '입면도', '단면도', '배치도', '구조도',
      '명부', '명단', '리스트', '목록', '일람표', '대장', '장부', '기록부',
      '세대주명부', '입주자명부', '거주자명부', '세대원명부', '입주민명부',
      '거주민명부', '세대명부', '입주자대표명부', '세대주대표명부',
      '관리위원회명부', '입주자회의명부', '세대주회의명부',
      
      // 🆕 절차 및 방법 관련 키워드
      '절차', '방법', '과정', '순서', '단계', '절차방법', '처리절차', '신청절차',
      '지정절차', '해제절차', '승인절차', '허가절차', '등록절차', '변경절차',
      '취소절차', '철회절차', '무효절차', '거부절차', '반려절차', '보류절차',
      '심사절차', '검토절차', '처리절차', '진행절차', '완료절차', '종료절차',
      '신청방법', '지정방법', '해제방법', '승인방법', '허가방법', '등록방법',
      '변경방법', '취소방법', '철회방법', '무효방법', '거부방법', '반려방법',
      '보류방법', '심사방법', '검토방법', '처리방법', '진행방법', '완료방법',
      '신청과정', '지정과정', '해제과정', '승인과정', '허가과정', '등록과정',
      '변경과정', '취소과정', '철회과정', '무효과정', '거부과정', '반려과정',
      '보류과정', '심사과정', '검토과정', '처리과정', '진행과정', '완료과정',
      '신청순서', '지정순서', '해제순서', '승인순서', '허가순서', '등록순서',
      '변경순서', '취소순서', '철회순서', '무효순서', '거부순서', '반려순서',
      '보류순서', '심사순서', '검토순서', '처리순서', '진행순서', '완료순서',
      '신청단계', '지정단계', '해제단계', '승인단계', '허가단계', '등록단계',
      '변경단계', '취소단계', '철회단계', '무효단계', '거부단계', '반려단계',
      '보류단계', '심사단계', '검토단계', '처리단계', '진행단계', '완료단계',
      
      // 🆕 요건 및 조건 관련 키워드
      '요건', '조건', '자격', '요구사항', '필수사항', '필수요건', '필수조건',
      '필수자격', '필수요구사항', '필수필수사항', '필수필수요건', '필수필수조건',
      '선택사항', '선택요건', '선택조건', '선택자격', '선택요구사항', '선택필수사항',
      '추가사항', '추가요건', '추가조건', '추가자격', '추가요구사항', '추가필수사항',
      '보완사항', '보완요건', '보완조건', '보완자격', '보완요구사항', '보완필수사항',
      '수정사항', '수정요건', '수정조건', '수정자격', '수정요구사항', '수정필수사항',
      '변경사항', '변경요건', '변경조건', '변경자격', '변경요구사항', '변경필수사항',
      '제한사항', '제한요건', '제한조건', '제한자격', '제한요구사항', '제한필수사항',
      '예외사항', '예외요건', '예외조건', '예외자격', '예외요구사항', '예외필수사항',
      '특례사항', '특례요건', '특례조건', '특례자격', '특례요구사항', '특례필수사항',
      '면제사항', '면제요건', '면제조건', '면제자격', '면제요구사항', '면제필수사항',
      '완화사항', '완화요건', '완화조건', '완화자격', '완화요구사항', '완화필수사항',
      '강화사항', '강화요건', '강화조건', '강화자격', '강화요구사항', '강화필수사항',
      
      // 🆕 비용 및 수수료 관련 키워드
      '비용', '수수료', '요금', '금액', '가격', '단가', '요율', '요금률',
      '신청비', '신청수수료', '신청요금', '신청금액', '신청가격', '신청단가',
      '지정비', '지정수수료', '지정요금', '지정금액', '지정가격', '지정단가',
      '해제비', '해제수수료', '해제요금', '해제금액', '해제가격', '해제단가',
      '승인비', '승인수수료', '승인요금', '승인금액', '승인가격', '승인단가',
      '허가비', '허가수수료', '허가요금', '허가금액', '허가가격', '허가단가',
      '등록비', '등록수수료', '등록요금', '등록금액', '등록가격', '등록단가',
      '변경비', '변경수수료', '변경요금', '변경금액', '변경가격', '변경단가',
      '취소비', '취소수수료', '취소요금', '취소금액', '취소가격', '취소단가',
      '철회비', '철회수수료', '철회요금', '철회금액', '철회가격', '철회단가',
      '무효비', '무효수수료', '무효요금', '무효금액', '무효가격', '무효단가',
      '거부비', '거부수수료', '거부요금', '거부금액', '거부가격', '거부단가',
      '반려비', '반려수수료', '반려요금', '반려금액', '반려가격', '반려단가',
      '보류비', '보류수수료', '보류요금', '보류금액', '보류가격', '보류단가',
      '심사비', '심사수수료', '심사요금', '심사금액', '심사가격', '심사단가',
      '검토비', '검토수수료', '검토요금', '검토금액', '검토가격', '검토단가',
      '처리비', '처리수수료', '처리요금', '처리금액', '처리가격', '처리단가',
      '진행비', '진행수수료', '진행요금', '진행금액', '진행가격', '진행단가',
      '완료비', '완료수수료', '완료요금', '완료금액', '완료가격', '완료단가',
      '무료', '무상', '무비용', '무수수료', '무요금', '무금액', '무가격',
      '유료', '유상', '유비용', '유수수료', '유요금', '유금액', '유가격',
      '할인', '할인비', '할인수수료', '할인요금', '할인금액', '할인가격',
      '면제', '면제비', '면제수수료', '면제요금', '면제금액', '면제가격',
      '감면', '감면비', '감면수수료', '감면요금', '감면금액', '감면가격',
      '환불', '환불비', '환불수수료', '환불요금', '환불금액', '환불가격',
      '보상', '보상비', '보상수수료', '보상요금', '보상금액', '보상가격',
      '배상', '배상비', '배상수수료', '배상요금', '배상금액', '배상가격',
      '손해', '손해비', '손해수수료', '손해요금', '손해금액', '손해가격',
      '피해', '피해비', '피해수수료', '피해요금', '피해금액', '피해가격',
      '보상금', '배상금', '손해금', '피해금', '보상비용', '배상비용',
      '손해비용', '피해비용', '보상수수료', '배상수수료', '손해수수료', '피해수수료',
      '보상요금', '배상요금', '손해요금', '피해요금', '보상금액', '배상금액',
      '손해금액', '피해금액', '보상가격', '배상가격', '손해가격', '피해가격',
      '보상단가', '배상단가', '손해단가', '피해단가', '보상요율', '배상요율',
      '손해요율', '피해요율', '보상요금률', '배상요금률', '손해요금률', '피해요금률',
      
      // 🆕 기타 중요 키워드
      '안전', '보안', '보호', '예방', '방지', '차단', '차단막', '차단벽',
      '환경', '환경보호', '환경보전', '환경관리', '환경정책', '환경규정',
      '공중', '공중보건', '공중위생', '공중안전', '공중보안', '공중보호',
      '국민', '국민건강', '국민보건', '국민안전', '국민보안', '국민보호',
      '사회', '사회보장', '사회복지', '사회안전', '사회보안', '사회보호',
      '지역', '지역사회', '지역보건', '지역안전', '지역보안', '지역보호',
      '시민', '시민건강', '시민보건', '시민안전', '시민보안', '시민보호',
      '주민', '주민건강', '주민보건', '주민안전', '주민보안', '주민보호',
      '거주자', '거주민', '입주자', '입주민', '세대주', '세대원', '세대',
      '관리자', '관리사', '관리업체', '관리회사', '관리단체', '관리조합',
      '담당자', '담당사', '담당업체', '담당회사', '담당단체', '담당조합',
      '책임자', '책임사', '책임업체', '책임회사', '책임단체', '책임조합',
      '의무자', '의무사', '의무업체', '의무회사', '의무단체', '의무조합',
      '권한자', '권한사', '권한업체', '권한회사', '권한단체', '권한조합',
      '기능자', '기능사', '기능업체', '기능회사', '기능단체', '기능조합',
      '역할자', '역할사', '역할업체', '역할회사', '역할단체', '역할조합',
      '교육자', '교육사', '교육업체', '교육회사', '교육단체', '교육조합',
      '홍보자', '홍보사', '홍보업체', '홍보회사', '홍보단체', '홍보조합',
      '점검자', '점검사', '점검업체', '점검회사', '점검단체', '점검조합',
      '통계자', '통계사', '통계업체', '통계회사', '통계단체', '통계조합',
      '분석자', '분석사', '분석업체', '분석회사', '분석단체', '분석조합',
      '개선자', '개선사', '개선업체', '개선회사', '개선단체', '개선조합',
      '지원자', '지원사', '지원업체', '지원회사', '지원단체', '지원조합',
      '협력자', '협력사', '협력업체', '협력회사', '협력단체', '협력조합',
      '평가자', '평가사', '평가업체', '평가회사', '평가단체', '평가조합',
      '운영자', '운영사', '운영업체', '운영회사', '운영단체', '운영조합',
      '개발자', '개발사', '개발업체', '개발회사', '개발단체', '개발조합',
      '보안자', '보안사', '보안업체', '보안회사', '보안단체', '보안조합',
      '업데이트자', '업데이트사', '업데이트업체', '업데이트회사', '업데이트단체', '업데이트조합',
      '장애자', '장애사', '장애업체', '장애회사', '장애단체', '장애조합',
      '대응자', '대응사', '대응업체', '대응회사', '대응단체', '대응조합',
      '보고자', '보고사', '보고업체', '보고회사', '보고단체', '보고조합',
      '제출자', '제출사', '제출업체', '제출회사', '제출단체', '제출조합',
      '접수자', '접수사', '접수업체', '접수회사', '접수단체', '접수조합',
      '심의자', '심의사', '심의업체', '심의회사', '심의단체', '심의조합',
      '검토자', '검토사', '검토업체', '검토회사', '검토단체', '검토조합'
    ];

    // 2. 하드코딩된 키워드에서 매칭되는 것들
    const matchedHardcoded = hardcodedKeywords.filter(keyword => 
      question.toLowerCase().includes(keyword.toLowerCase())
    );

    // 3. 동적 키워드 추출 (기존 방식 유지)
    const dynamicKeywords = question
      .toLowerCase()
      .replace(/[^\w\s가-힣]/g, ' ')
      .split(/\s+/)
      .filter(word => word.length > 1)
      .filter(word => !this.isStopWord(word));

    // 4. 하이브리드 결과 반환
    return [...new Set([...matchedHardcoded, ...dynamicKeywords])];
  }

  /**
   * 기타 키워드 추출 (공동주택 외 일반 키워드)
   */
  private extractOtherKeywords(question: string): string[] {
    // 기본 금연 관련 키워드
    const basicKeywords = [
      '금연', '금연구역', '건강증진', '시행령', '시행규칙', '지정', '관리', '업무', '지침',
      '서비스', '통합', '사업', '지원', '규정', '법률', '조항', '항목', '절차', '방법',
      '기준', '요건', '조건', '제한', '신고', '신청', '처리', '심사', '승인', '허가',
      '등록', '변경', '취소', '정지', '폐지', '해제', '위반', '과태료', '벌금', '처벌',
      '제재', '조치', '시설', '장소', '구역', '지역', '범위', '대상', '기관', '단체',
      '조직', '협회', '연합', '연합회', '담당', '책임', '의무', '권한', '기능', '역할',
      '교육', '홍보', '점검', '통계', '분석', '개선', '지원', '협력', '평가', '운영',
      '개발', '보안', '업데이트', '장애', '대응', '보고', '제출', '접수', '심의', '검토',
      // 어린이 관련 키워드
      '어린이집', '유치원', '학교', '초등학교', '중학교', '고등학교', '대학교',
      '보육', '교육', '학생', '어린이', '청소년', '아동', '영유아', '영유아보육',
      '유아교육', '보육시설', '교육시설', '학원', '어린이보호', '아동보호'
    ];

    // 하드코딩된 키워드에서 매칭되는 것들
    const matchedBasic = basicKeywords.filter(keyword => 
      question.toLowerCase().includes(keyword.toLowerCase())
    );

    // 동적 키워드 추출
    const dynamicKeywords = question
      .toLowerCase()
      .replace(/[^\w\s가-힣]/g, ' ')
      .split(/\s+/)
      .filter(word => word.length > 1)
      .filter(word => !this.isStopWord(word));

    return [...new Set([...matchedBasic, ...dynamicKeywords])];
  }

  /**
   * 불용어 체크
   */
  private isStopWord(word: string): boolean {
    const stopWords = [
      '은', '는', '이', '가', '을', '를', '에', '의', '로', '으로', '와', '과',
      '에서', '부터', '까지', '에게', '한테', '께', '도', '만', '조차', '마저',
      '또한', '그리고', '하지만', '그런데', '그러나', '따라서', '그래서',
      '어떻게', '무엇', '언제', '어디', '왜', '누구', '어느', '몇',
      'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by'
    ];
    return stopWords.includes(word);
  }

  /**
   * 카테고리 분류
   */
  private classifyCategory(question: string): string {
    const lowerQuestion = question.toLowerCase();
    
    if (lowerQuestion.includes('무엇') || lowerQuestion.includes('정의') || lowerQuestion.includes('의미')) {
      return 'definition';
    }
    if (lowerQuestion.includes('어떻게') || lowerQuestion.includes('절차') || lowerQuestion.includes('방법')) {
      return 'procedure';
    }
    if (lowerQuestion.includes('규정') || lowerQuestion.includes('법령') || lowerQuestion.includes('조항')) {
      return 'regulation';
    }
    if (lowerQuestion.includes('비교') || lowerQuestion.includes('차이') || lowerQuestion.includes('vs')) {
      return 'comparison';
    }
    if (lowerQuestion.includes('분석') || lowerQuestion.includes('검토') || lowerQuestion.includes('평가')) {
      return 'analysis';
    }

    return 'general';
  }

  /**
   * 복잡도 평가
   */
  private assessComplexity(question: string): string {
    const wordCount = question.split(/\s+/).length;
    const hasMultipleQuestions = (question.match(/\?/g) || []).length > 1;
    const hasComplexTerms = /법령|규정|절차|기준|요건|조건/.test(question);
    
    if (wordCount > 20 || hasMultipleQuestions || hasComplexTerms) {
      return 'complex';
    } else if (wordCount > 10) {
      return 'medium';
    } else {
      return 'simple';
    }
  }

  /**
   * 개체 추출 (확장된 패턴)
   */
  private extractEntities(question: string): string[] {
    const entities: string[] = [];
    
    // 확장된 법령명 패턴
    const lawPatterns = [
      /국민건강증진법률/gi,
      /시행령/gi,
      /시행규칙/gi,
      /질서위반행위규제법/gi,
      /영유아보육법/gi,
      /유아교육법/gi,
      /초중등교육법/gi,
      /고등교육법/gi
    ];
    
    // 확장된 기관명 패턴
    const orgPatterns = [
      /보건복지부/gi,
      /시도/gi,
      /시군구/gi,
      /지역사회/gi,
      /보건소/gi,
      /보건의료원/gi,
      /보건지소/gi
    ];
    
    // 시설명 패턴 추가
    const facilityPatterns = [
      /어린이집/gi,
      /유치원/gi,
      /초등학교/gi,
      /중학교/gi,
      /고등학교/gi,
      /대학교/gi,
      /의료기관/gi,
      /학교/gi
    ];
    
    // 모든 패턴 적용
    [...lawPatterns, ...orgPatterns, ...facilityPatterns].forEach(pattern => {
      const matches = question.match(pattern);
      if (matches) {
        entities.push(...matches);
      }
    });

    // 기존 방식도 유지 (추가적인 개체 추출)
    const institutions = question.match(/[가-힣]+(청|부|원|소|센터|기관|단체|협회)/g);
    if (institutions) entities.push(...institutions);
    
    const laws = question.match(/[가-힣]+(법|령|규칙|지침|가이드라인|매뉴얼)/g);
    if (laws) entities.push(...laws);
    
    const numbers = question.match(/\d+(m|km|미터|킬로미터|%|퍼센트|원|만원|억원)/g);
    if (numbers) entities.push(...numbers);
    
    return [...new Set(entities)]; // 중복 제거
  }

  /**
   * 의도 생성
   */
  private generateIntent(question: string, keywords: string[]): string {
    const keyTerms = keywords.slice(0, 3).join(', ');
    return `${keyTerms}에 대한 문의`;
  }
}

/**
 * 컨텍스트 선택기
 */
export class ContextSelector {
  private static chunks: Chunk[] = [];
  
  // 한국어 동의어 사전 (대폭 확장)
  private static readonly KOREAN_SYNONYMS: Record<string, string[]> = {
    // 기본 금연 관련 동의어
    '금연': ['금연사업', '담배금지', '흡연금지', '금연정책', '금연운동', '금연지원', '금연캠페인', '금연교육', '금연상담', '금연치료'],
    '금연구역': ['금연지역', '금연장소', '금연공간', '금연시설', '금연건물', '금연실', '금연구역', '금연영역', '금연범위', '금연대상'],
    '흡연': ['담배피우기', '담배흡연', '흡연행위', '흡연활동', '흡연행동', '흡연습관', '흡연문화', '흡연현상', '흡연문제', '흡연피해'],
    '흡연실': ['흡연구역', '흡연지역', '흡연장소', '흡연공간', '흡연시설', '흡연건물', '흡연부스', '흡연공간', '흡연실내', '흡연실외'],
    '지정': ['선정', '고시', '공시', '발표', '선정', '지정고시', '지정공고', '지정알림', '지정안내', '지정표시'],
    '관리': ['운영', '관할', '담당', '처리', '관리운영', '관리업무', '관리책임', '관리의무', '관리권한', '관리기능'],
    '절차': ['방법', '과정', '순서', '단계', '절차방법', '처리절차', '신청절차', '지정절차', '해제절차', '승인절차'],
    '신청': ['접수', '제출', '등록', '신고', '신청접수', '제출신청', '신청서', '신청서류', '신청서식', '신청양식'],
    '심사': ['검토', '심의', '평가', '심사검토', '심의평가', '심사절차', '심사과정', '심사방법', '심사기준', '심사요건'],
    '승인': ['허가', '인가', '승인허가', '인가승인', '승인절차', '승인과정', '승인방법', '승인기준', '승인요건', '승인조건'],
    '규정': ['법령', '규칙', '지침', '규정사항', '법규', '법률', '조항', '항목', '조문', '규칙'],
    '지침': ['가이드', '매뉴얼', '지침서', '운영지침', '업무지침', '관리지침', '처리지침', '운영가이드', '업무가이드', '관리가이드'],
    '서비스': ['지원', '제공', '서비스지원', '지원서비스', '서비스제공', '지원제공', '서비스관리', '지원관리', '서비스운영', '지원운영'],
    '건강증진': ['건강향상', '건강증진사업', '건강관리', '건강보호', '건강유지', '건강개선', '건강향상', '건강증진정책', '건강증진계획', '건강증진프로그램'],
    '시설': ['장소', '시설물', '건물', '공간', '시설건물', '시설공간', '시설장소', '시설물건물', '시설물공간', '시설물장소'],
    '위반': ['위반행위', '위반사항', '위반처리', '위반자', '위반행동', '위반활동', '위반현상', '위반문제', '위반사고', '위반사건'],
    '과태료': ['벌금', '과금', '처벌', '제재', '과태료부과', '벌금부과', '과금부과', '처벌부과', '제재부과', '과태료징수'],
    '보고': ['제출', '보고서', '보고사항', '보고제출', '보고서제출', '보고사항제출', '보고제출서', '보고서양식', '보고서서식', '보고서양식'],
    '교육': ['훈련', '교육프로그램', '교육과정', '연수', '교육훈련', '훈련교육', '교육연수', '연수교육', '교육과정', '훈련과정'],
    '홍보': ['선전', '홍보활동', '홍보사업', '홍보물', '홍보선전', '선전홍보', '홍보활동', '홍보사업', '홍보물제작', '홍보물배포'],
    '점검': ['검사', '점검사항', '점검업무', '모니터링', '점검검사', '검사점검', '점검모니터링', '모니터링점검', '점검활동', '점검사업'],
    '통계': ['통계자료', '통계분석', '통계수집', '데이터', '통계데이터', '데이터통계', '통계수집', '수집통계', '통계분석', '분석통계'],
    '분석': ['검토', '분석자료', '분석결과', '연구', '분석검토', '검토분석', '분석연구', '연구분석', '분석활동', '분석사업'],
    '개선': ['향상', '개선사항', '개선방안', '개선계획', '개선향상', '향상개선', '개선활동', '개선사업', '개선프로그램', '개선지침'],
    '지원': ['도움', '지원사업', '지원활동', '지원정책', '지원도움', '도움지원', '지원서비스', '서비스지원', '지원프로그램', '지원계획'],
    '협력': ['협조', '협력사업', '협력활동', '연계', '협력협조', '협조협력', '협력연계', '연계협력', '협력관계', '협력체계'],
    '평가': ['검증', '평가사항', '평가결과', '성과평가', '평가검증', '검증평가', '평가활동', '평가사업', '평가프로그램', '평가지침'],
    '운영': ['관리', '운영방법', '운영계획', '운영지침', '운영관리', '관리운영', '운영활동', '운영사업', '운영프로그램', '운영체계'],
    '개발': ['구축', '개발사업', '개발계획', '시스템개발', '개발구축', '구축개발', '개발활동', '개발사업', '개발프로그램', '개발지침'],
    '보안': ['안전', '보안관리', '보안사항', '정보보안', '보안안전', '안전보안', '보안활동', '보안사업', '보안프로그램', '보안지침'],
    '업데이트': ['갱신', '수정', '변경', '개선', '업데이트갱신', '갱신업데이트', '업데이트수정', '수정업데이트', '업데이트변경', '변경업데이트'],
    '장애': ['문제', '오류', '장애처리', '문제해결', '장애문제', '문제장애', '장애오류', '오류장애', '장애해결', '해결장애'],
    '대응': ['처리', '대응방안', '대응절차', '대응계획', '대응처리', '처리대응', '대응활동', '대응사업', '대응프로그램', '대응지침'],
    
    // 🆕 공동주택 관련 동의어 (대폭 확장)
    '공동주택': ['아파트', '오피스텔', '빌라', '연립주택', '다세대주택', '집합주택', '주거시설', '주거용건물', '공동주거', '공동거주'],
    '아파트': ['공동주택', '아파트단지', '아파트동', '아파트건물', '아파트시설', '아파트공간', '아파트장소', '아파트구역', '아파트지역', '아파트범위'],
    '오피스텔': ['공동주택', '오피스텔동', '오피스텔건물', '오피스텔시설', '오피스텔공간', '오피스텔장소', '오피스텔구역', '오피스텔지역', '오피스텔범위', '오피스텔대상'],
    '빌라': ['공동주택', '빌라동', '빌라건물', '빌라시설', '빌라공간', '빌라장소', '빌라구역', '빌라지역', '빌라범위', '빌라대상'],
    '연립주택': ['공동주택', '연립주택동', '연립주택건물', '연립주택시설', '연립주택공간', '연립주택장소', '연립주택구역', '연립주택지역', '연립주택범위', '연립주택대상'],
    '다세대주택': ['공동주택', '다세대주택동', '다세대주택건물', '다세대주택시설', '다세대주택공간', '다세대주택장소', '다세대주택구역', '다세대주택지역', '다세대주택범위', '다세대주택대상'],
    '집합주택': ['공동주택', '집합주택동', '집합주택건물', '집합주택시설', '집합주택공간', '집합주택장소', '집합주택구역', '집합주택지역', '집합주택범위', '집합주택대상'],
    '주거시설': ['공동주택', '주거용건물', '주거건물', '주거시설물', '주거시설건물', '주거시설공간', '주거시설장소', '주거시설구역', '주거시설지역', '주거시설범위'],
    '주거용건물': ['공동주택', '주거시설', '주거건물', '주거용시설', '주거용시설물', '주거용시설건물', '주거용시설공간', '주거용시설장소', '주거용시설구역', '주거용시설지역'],
    '공동주거': ['공동주택', '공동거주', '공동생활', '공동거주시설', '공동생활시설', '공동주거시설', '공동거주시설물', '공동생활시설물', '공동주거시설물', '공동거주시설건물'],
    '공동거주': ['공동주택', '공동주거', '공동생활', '공동거주시설', '공동생활시설', '공동주거시설', '공동거주시설물', '공동생활시설물', '공동주거시설물', '공동거주시설건물'],
    '공동생활': ['공동주택', '공동주거', '공동거주', '공동생활시설', '공동거주시설', '공동주거시설', '공동생활시설물', '공동거주시설물', '공동주거시설물', '공동생활시설건물'],
    '공동거주시설': ['공동주택', '공동주거', '공동거주', '공동생활', '공동생활시설', '공동주거시설', '공동거주시설물', '공동생활시설물', '공동주거시설물', '공동거주시설건물'],
    
    // 🆕 필로티 관련 동의어
    '필로티': ['기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간', '기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간'],
    '기둥공간': ['필로티', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간', '기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간'],
    '기둥지지공간': ['필로티', '기둥공간', '개방공간', '지지공간', '기둥하부공간', '기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간'],
    '개방공간': ['필로티', '기둥공간', '기둥지지공간', '지지공간', '기둥하부공간', '기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간'],
    '지지공간': ['필로티', '기둥공간', '기둥지지공간', '개방공간', '기둥하부공간', '기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간'],
    '기둥하부공간': ['필로티', '기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간'],
    
    // 🆕 공용공간 관련 동의어
    '공용공간': ['공용시설', '공동시설', '공용구역', '공동구역', '공용부지', '공동부지', '공용공간', '공동공간', '공용장소', '공동장소'],
    '공용시설': ['공용공간', '공동시설', '공용구역', '공동구역', '공용부지', '공동부지', '공용공간', '공동공간', '공용장소', '공동장소'],
    '공동시설': ['공용공간', '공용시설', '공용구역', '공동구역', '공용부지', '공동부지', '공용공간', '공동공간', '공용장소', '공동장소'],
    '공용구역': ['공용공간', '공용시설', '공동시설', '공동구역', '공용부지', '공동부지', '공용공간', '공동공간', '공용장소', '공동장소'],
    '공동구역': ['공용공간', '공용시설', '공동시설', '공용구역', '공용부지', '공동부지', '공용공간', '공동공간', '공용장소', '공동장소'],
    '공용부지': ['공용공간', '공용시설', '공동시설', '공용구역', '공동구역', '공동부지', '공용공간', '공동공간', '공용장소', '공동장소'],
    '공동부지': ['공용공간', '공용시설', '공동시설', '공용구역', '공동구역', '공용부지', '공용공간', '공동공간', '공용장소', '공동장소'],
    
    // 🆕 복도 관련 동의어
    '복도': ['통로', '복도공간', '통로공간', '복도구역', '통로구역', '복도통로', '통로복도', '복도공간', '통로공간', '복도장소'],
    '통로': ['복도', '복도공간', '통로공간', '복도구역', '통로구역', '복도통로', '통로복도', '복도공간', '통로공간', '복도장소'],
    '복도공간': ['복도', '통로', '통로공간', '복도구역', '통로구역', '복도통로', '통로복도', '복도공간', '통로공간', '복도장소'],
    '통로공간': ['복도', '통로', '복도공간', '복도구역', '통로구역', '복도통로', '통로복도', '복도공간', '통로공간', '복도장소'],
    '복도구역': ['복도', '통로', '복도공간', '통로공간', '통로구역', '복도통로', '통로복도', '복도공간', '통로공간', '복도장소'],
    '통로구역': ['복도', '통로', '복도공간', '통로공간', '복도구역', '복도통로', '통로복도', '복도공간', '통로공간', '복도장소'],
    
    // 🆕 계단 관련 동의어
    '계단': ['계단실', '계단공간', '계단구역', '승강계단', '비상계단', '계단통로', '계단공간', '계단장소', '계단시설', '계단건물'],
    '계단실': ['계단', '계단공간', '계단구역', '승강계단', '비상계단', '계단통로', '계단공간', '계단장소', '계단시설', '계단건물'],
    '계단공간': ['계단', '계단실', '계단구역', '승강계단', '비상계단', '계단통로', '계단공간', '계단장소', '계단시설', '계단건물'],
    '계단구역': ['계단', '계단실', '계단공간', '승강계단', '비상계단', '계단통로', '계단공간', '계단장소', '계단시설', '계단건물'],
    '승강계단': ['계단', '계단실', '계단공간', '계단구역', '비상계단', '계단통로', '계단공간', '계단장소', '계단시설', '계단건물'],
    '비상계단': ['계단', '계단실', '계단공간', '계단구역', '승강계단', '계단통로', '계단공간', '계단장소', '계단시설', '계단건물'],
    
    // 🆕 엘리베이터 관련 동의어
    '엘리베이터': ['승강기', '엘리베이터실', '승강기실', '승강기구역', '엘리베이터구역', '승강기공간', '엘리베이터공간', '승강기장소', '엘리베이터장소', '승강기시설'],
    '승강기': ['엘리베이터', '엘리베이터실', '승강기실', '승강기구역', '엘리베이터구역', '승강기공간', '엘리베이터공간', '승강기장소', '엘리베이터장소', '승강기시설'],
    '엘리베이터실': ['엘리베이터', '승강기', '승강기실', '승강기구역', '엘리베이터구역', '승강기공간', '엘리베이터공간', '승강기장소', '엘리베이터장소', '승강기시설'],
    '승강기실': ['엘리베이터', '승강기', '엘리베이터실', '승강기구역', '엘리베이터구역', '승강기공간', '엘리베이터공간', '승강기장소', '엘리베이터장소', '승강기시설'],
    '승강기구역': ['엘리베이터', '승강기', '엘리베이터실', '승강기실', '엘리베이터구역', '승강기공간', '엘리베이터공간', '승강기장소', '엘리베이터장소', '승강기시설'],
    '엘리베이터구역': ['엘리베이터', '승강기', '엘리베이터실', '승강기실', '승강기구역', '승강기공간', '엘리베이터공간', '승강기장소', '엘리베이터장소', '승강기시설'],
    
    // 🆕 지하주차장 관련 동의어
    '지하주차장': ['지하주차공간', '지하주차구역', '지하주차시설', '지하주차공간', '지하주차장소', '지하주차건물', '지하주차시설물', '지하주차시설건물', '지하주차시설공간', '지하주차시설장소'],
    '지하주차공간': ['지하주차장', '지하주차구역', '지하주차시설', '지하주차공간', '지하주차장소', '지하주차건물', '지하주차시설물', '지하주차시설건물', '지하주차시설공간', '지하주차시설장소'],
    '지하주차구역': ['지하주차장', '지하주차공간', '지하주차시설', '지하주차공간', '지하주차장소', '지하주차건물', '지하주차시설물', '지하주차시설건물', '지하주차시설공간', '지하주차시설장소'],
    '지하주차시설': ['지하주차장', '지하주차공간', '지하주차구역', '지하주차공간', '지하주차장소', '지하주차건물', '지하주차시설물', '지하주차시설건물', '지하주차시설공간', '지하주차시설장소'],
    
    // 🆕 세대주 관련 동의어
    '세대주': ['입주자', '거주자', '세대원', '입주민', '거주민', '세대', '세대주대표', '입주자대표', '세대주회의', '입주자회의'],
    '입주자': ['세대주', '거주자', '세대원', '입주민', '거주민', '세대', '입주자대표', '세대주대표', '입주자회의', '세대주회의'],
    '거주자': ['세대주', '입주자', '세대원', '입주민', '거주민', '세대', '거주자대표', '세대주대표', '거주자회의', '세대주회의'],
    '세대원': ['세대주', '입주자', '거주자', '입주민', '거주민', '세대', '세대원대표', '세대주대표', '세대원회의', '세대주회의'],
    '입주민': ['세대주', '입주자', '거주자', '세대원', '거주민', '세대', '입주민대표', '세대주대표', '입주민회의', '세대주회의'],
    '거주민': ['세대주', '입주자', '거주자', '세대원', '입주민', '세대', '거주민대표', '세대주대표', '거주민회의', '세대주회의'],
    '세대': ['세대주', '입주자', '거주자', '세대원', '입주민', '거주민', '세대대표', '세대주대표', '세대회의', '세대주회의'],
    
    // 🆕 관리사무소 관련 동의어
    '관리사무소': ['관리사', '관리업체', '관리회사', '관리단체', '관리조합', '관리사무소', '관리사무소사', '관리사무소업체', '관리사무소회사', '관리사무소단체'],
    '관리사': ['관리사무소', '관리업체', '관리회사', '관리단체', '관리조합', '관리사무소', '관리사무소사', '관리사무소업체', '관리사무소회사', '관리사무소단체'],
    '관리업체': ['관리사무소', '관리사', '관리회사', '관리단체', '관리조합', '관리사무소', '관리사무소사', '관리사무소업체', '관리사무소회사', '관리사무소단체'],
    '관리회사': ['관리사무소', '관리사', '관리업체', '관리단체', '관리조합', '관리사무소', '관리사무소사', '관리사무소업체', '관리사무소회사', '관리사무소단체'],
    '관리단체': ['관리사무소', '관리사', '관리업체', '관리회사', '관리조합', '관리사무소', '관리사무소사', '관리사무소업체', '관리사무소회사', '관리사무소단체'],
    '관리조합': ['관리사무소', '관리사', '관리업체', '관리회사', '관리단체', '관리사무소', '관리사무소사', '관리사무소업체', '관리사무소회사', '관리사무소단체'],
    
    // 🆕 동의 관련 동의어
    '동의': ['투표', '동의서', '투표서', '승인서', '합의서', '찬성', '반대', '동의투표', '투표동의', '동의서제출', '투표서제출'],
    '투표': ['동의', '동의서', '투표서', '승인서', '합의서', '찬성', '반대', '동의투표', '투표동의', '동의서제출', '투표서제출'],
    '동의서': ['동의', '투표', '투표서', '승인서', '합의서', '찬성', '반대', '동의투표', '투표동의', '동의서제출', '투표서제출'],
    '투표서': ['동의', '투표', '동의서', '승인서', '합의서', '찬성', '반대', '동의투표', '투표동의', '동의서제출', '투표서제출'],
    '승인서': ['동의', '투표', '동의서', '투표서', '합의서', '찬성', '반대', '동의투표', '투표동의', '동의서제출', '투표서제출'],
    '합의서': ['동의', '투표', '동의서', '투표서', '승인서', '찬성', '반대', '동의투표', '투표동의', '동의서제출', '투표서제출'],
    '찬성': ['동의', '투표', '동의서', '투표서', '승인서', '합의서', '반대', '동의투표', '투표동의', '동의서제출', '투표서제출'],
    '반대': ['동의', '투표', '동의서', '투표서', '승인서', '합의서', '찬성', '동의투표', '투표동의', '동의서제출', '투표서제출'],
    
    // 🆕 신청 관련 동의어
    '지정신청': ['해제신청', '신청서', '신청절차', '신청방법', '신청기간', '신청자격', '신청요건', '신청조건', '신청서류', '신청비용'],
    '해제신청': ['지정신청', '신청서', '신청절차', '신청방법', '신청기간', '신청자격', '신청요건', '신청조건', '신청서류', '신청비용'],
    '신청서': ['지정신청', '해제신청', '신청절차', '신청방법', '신청기간', '신청자격', '신청요건', '신청조건', '신청서류', '신청비용'],
    '신청절차': ['지정신청', '해제신청', '신청서', '신청방법', '신청기간', '신청자격', '신청요건', '신청조건', '신청서류', '신청비용'],
    '신청방법': ['지정신청', '해제신청', '신청서', '신청절차', '신청기간', '신청자격', '신청요건', '신청조건', '신청서류', '신청비용'],
    '신청기간': ['지정신청', '해제신청', '신청서', '신청절차', '신청방법', '신청자격', '신청요건', '신청조건', '신청서류', '신청비용'],
    '신청자격': ['지정신청', '해제신청', '신청서', '신청절차', '신청방법', '신청기간', '신청요건', '신청조건', '신청서류', '신청비용'],
    '신청요건': ['지정신청', '해제신청', '신청서', '신청절차', '신청방법', '신청기간', '신청자격', '신청조건', '신청서류', '신청비용'],
    '신청조건': ['지정신청', '해제신청', '신청서', '신청절차', '신청방법', '신청기간', '신청자격', '신청요건', '신청서류', '신청비용'],
    '신청서류': ['지정신청', '해제신청', '신청서', '신청절차', '신청방법', '신청기간', '신청자격', '신청요건', '신청조건', '신청비용'],
    '신청비용': ['지정신청', '해제신청', '신청서', '신청절차', '신청방법', '신청기간', '신청자격', '신청요건', '신청조건', '신청서류'],
    
    // 🆕 어린이 관련 동의어 (기존 확장)
    '어린이집': ['보육시설', '어린이보육시설', '보육원', '어린이보육원', '보육시설물', '어린이보육시설물', '보육시설건물', '어린이보육시설건물', '보육시설공간', '어린이보육시설공간'],
    '유치원': ['유아교육기관', '유치원시설'],
    '학교': ['교육기관', '학원', '교실']
  };

  /**
   * 청크 설정
   */
  static setChunks(chunks: Chunk[]): void {
    this.chunks = chunks;
    console.log(`ContextSelector에 ${chunks.length}개 청크 설정 완료`);
  }

  /**
   * 저장된 청크 가져오기
   */
  static getChunks(): Chunk[] {
    return this.chunks;
  }

  /**
   * 동의어 확장 검색
   */
  private static expandWithSynonyms(keywords: string[]): string[] {
    const expandedKeywords = [...keywords];
    
    keywords.forEach(keyword => {
      if (this.KOREAN_SYNONYMS[keyword]) {
        expandedKeywords.push(...this.KOREAN_SYNONYMS[keyword]);
      }
    });
    
    return [...new Set(expandedKeywords)];
  }

  /**
   * 부분 매칭 점수 계산
   */
  private static calculatePartialMatches(chunk: Chunk, keywords: string[]): number {
    let partialScore = 0;
    
    keywords.forEach(keyword => {
      // 키워드의 일부가 포함되어도 점수 부여
      if (keyword.length > 2 && chunk.content.toLowerCase().includes(keyword.substring(0, 2))) {
        partialScore += 0.5;
      }
    });
    
    return partialScore;
  }

  /**
   * 질문 분석 결과를 바탕으로 관련 컨텍스트 선택 (개선된 버전) - 공동주택 특별 처리
   */
  static selectRelevantContexts(
    questionAnalysis: QuestionAnalysis,
    allChunks: Chunk[],
    maxChunks: number = 5
  ): Chunk[] {
    if (!questionAnalysis || allChunks.length === 0) {
      return [];
    }

    // 🆕 공동주택 관련 키워드 체크
    const apartmentKeywords = [
      '공동주택', '아파트', '오피스텔', '빌라', '연립주택', '다세대주택', '집합주택',
      '필로티', '기둥공간', '기둥지지공간', '개방공간', '지지공간', '기둥하부공간',
      '공용공간', '공용시설', '공동시설', '공용구역', '공동구역', '공용부지',
      '복도', '통로', '복도공간', '통로공간', '복도구역', '통로구역',
      '계단', '계단실', '계단공간', '계단구역', '승강계단', '비상계단',
      '엘리베이터', '승강기', '엘리베이터실', '승강기실', '승강기구역',
      '지하주차장', '지하주차공간', '지하주차구역', '지하주차시설',
      '세대주', '입주자', '거주자', '세대원', '입주민', '거주민', '세대',
      '관리사무소', '관리사', '관리업체', '관리회사', '관리단체', '관리조합',
      '동의', '투표', '동의서', '투표서', '승인서', '합의서', '찬성', '반대',
      '지정신청', '해제신청', '신청서', '신청절차', '신청방법', '신청기간'
    ];

    const hasApartmentContext = questionAnalysis.keywords.some(keyword =>
      apartmentKeywords.includes(keyword.toLowerCase())
    );

    // 키워드 기반 점수 계산 (개선된 버전)
    const scoredChunks = allChunks.map(chunk => {
      let score = 0;

      // 1. 키워드 매칭 점수 (기본)
      const keywordMatches = questionAnalysis.keywords.filter(keyword =>
        chunk.content.toLowerCase().includes(keyword.toLowerCase())
      ).length;
      score += keywordMatches * 2;

      // 🆕 공동주택 관련 특별 처리
      if (hasApartmentContext) {
        // 공동주택 관련 키워드에 높은 가중치
        const apartmentMatches = questionAnalysis.keywords.filter(keyword =>
          apartmentKeywords.includes(keyword.toLowerCase()) &&
          chunk.content.toLowerCase().includes(keyword.toLowerCase())
        ).length;
        score += apartmentMatches * 5; // 공동주택 키워드는 5배 가중치

        // 공동주택 관련 내용이 포함된 청크에 보너스 점수
        if (chunk.content.includes('공동주택') || 
            chunk.content.includes('아파트') || 
            chunk.content.includes('필로티') ||
            chunk.content.includes('세대주') ||
            chunk.content.includes('입주자') ||
            chunk.content.includes('관리사무소')) {
          score += 10; // 공동주택 관련 내용 보너스
        }
      }

      // 2. 동의어 확장 검색 점수 (새로 추가)
      const expandedKeywords = this.expandWithSynonyms(questionAnalysis.keywords);
      const synonymMatches = expandedKeywords.filter(keyword =>
        chunk.content.toLowerCase().includes(keyword.toLowerCase())
      ).length;
      score += synonymMatches * 1.5; // 동의어는 낮은 가중치

      // 3. 개체 매칭 점수
      const entityMatches = questionAnalysis.entities.filter(entity =>
        chunk.content.includes(entity)
      ).length;
      score += entityMatches * 3;

      // 4. 부분 매칭 점수 (새로 추가)
      const partialMatches = this.calculatePartialMatches(chunk, questionAnalysis.keywords);
      score += partialMatches;

      // 5. 카테고리별 가중치 (chat4 방식)
      if (questionAnalysis.category === 'definition' && 
          (chunk.content.includes('정의') || chunk.content.includes('의미'))) {
        score += 2;
      }
      
      if (questionAnalysis.category === 'procedure' && 
          (chunk.content.includes('절차') || chunk.content.includes('방법') || chunk.content.includes('단계'))) {
        score += 2;
      }
      
      if (questionAnalysis.category === 'regulation' && 
          (chunk.content.includes('규정') || chunk.content.includes('법령') || chunk.content.includes('조항'))) {
        score += 2;
      }
      
      // 6. 복잡도에 따른 가중치
      if (questionAnalysis.complexity === 'complex') {
        score += 1; // 복잡한 질문은 더 많은 컨텍스트 필요
      }
      
      return { ...chunk, score };
    });

    // 점수순으로 정렬하고 상위 N개 선택
    return scoredChunks
      .sort((a, b) => b.score - a.score)
      .slice(0, maxChunks)
      .map(({ score, ...chunk }) => chunk); // score 제거
  }

  /**
   * 질문과 청크 간의 의미적 유사도 계산 (간단한 버전)
   */
  private static calculateSemanticSimilarity(question: string, chunk: Chunk): number {
    const questionWords = question.toLowerCase().split(/\s+/);
    const chunkWords = chunk.content.toLowerCase().split(/\s+/);
    
    const intersection = questionWords.filter(word => chunkWords.includes(word));
    const union = [...new Set([...questionWords, ...chunkWords])];
    
    return intersection.length / union.length; // Jaccard 유사도
  }

  /**
   * 질문을 분석하고 관련 컨텍스트를 선택하는 통합 메서드
   */
  static async selectRelevantContext(
    question: string, 
    questionAnalysis: QuestionAnalysis
  ): Promise<Chunk[]> {
    const allChunks = this.getChunks();
    if (allChunks.length === 0) {
      console.warn('ContextSelector에 설정된 청크가 없습니다.');
      return [];
    }
    
    return this.selectRelevantContexts(questionAnalysis, allChunks);
  }
}

// 싱글톤 인스턴스 생성
export const questionAnalyzer = new QuestionAnalyzer();
export const contextSelector = ContextSelector;