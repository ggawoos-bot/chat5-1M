name: Robust PDF Processing

on:
  push:
    branches: [ master, main ]
    paths:
      - 'public/pdf/**'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      chunkSize:
        description: 'ì²­í¬ í¬ê¸° (ë¬¸ì ìˆ˜)'
        required: true
        default: '2000'
        type: string
      overlapSize:
        description: 'ì˜¤ë²„ë© í¬ê¸° (ë¬¸ì ìˆ˜)'
        required: true
        default: '200'
        type: string
      forceReprocess:
        description: 'ê°•ì œ ì¬ì²˜ë¦¬'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  process-pdfs:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # íƒ€ì„ì•„ì›ƒ ì„¤ì •
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Create required directories
      run: |
        echo "ğŸ“ í•„ìš”í•œ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
        mkdir -p public/data
        mkdir -p dist/data
        echo "âœ… ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"
        ls -la public/
        ls -la dist/
      
    - name: Verify PDF files
      run: |
        echo "ğŸ“‹ PDF íŒŒì¼ í™•ì¸ ì¤‘..."
        ls -la public/pdf/
        echo "ğŸ“„ PDF íŒŒì¼ ìˆ˜: $(ls public/pdf/*.pdf | wc -l)"
        
        # PDF íŒŒì¼ ì¡´ì¬ í™•ì¸
        if [ ! -f "public/pdf/manifest.json" ]; then
          echo "âŒ manifest.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        # PDF íŒŒì¼ í¬ê¸° í™•ì¸
        for pdf in public/pdf/*.pdf; do
          if [ -f "$pdf" ]; then
            size=$(stat -c%s "$pdf")
            echo "ğŸ“„ $(basename "$pdf"): ${size} bytes"
            if [ $size -lt 1000 ]; then
              echo "âš ï¸ ê²½ê³ : $(basename "$pdf") íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤."
            fi
          fi
        done
        
    - name: Process PDFs with robust error handling
      run: |
        echo "ğŸš€ ê°•í™”ëœ PDF ì²˜ë¦¬ ì‹œì‘..."
        echo "í™˜ê²½ë³€ìˆ˜ ì„¤ì •:"
        echo "  CHUNK_SIZE: ${{ github.event.inputs.chunkSize || 2000 }}"
        echo "  OVERLAP_SIZE: ${{ github.event.inputs.overlapSize || 200 }}"
        echo "  FORCE_REPROCESS: ${{ github.event.inputs.forceReprocess || false }}"
        
        # Node.js í™˜ê²½ ì„¤ì • (PDF íŒŒì‹± ìµœì í™”)
        export NODE_OPTIONS="--max-old-space-size=4096 --no-experimental-fetch"
        export PDF_PARSER_OPTIONS="--no-sandbox"
        export NODE_ENV="production"
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        export CHUNK_SIZE=${{ github.event.inputs.chunkSize || 2000 }}
        export OVERLAP_SIZE=${{ github.event.inputs.overlapSize || 200 }}
        export FORCE_REPROCESS=${{ github.event.inputs.forceReprocess || false }}
        export GITHUB_ACTIONS=true
        
        # í´ë¦¬í•„ í™˜ê²½ ì„¤ì •
        export NODE_POLYFILLS="dom,canvas"
        
        echo "ğŸ”§ Node.js í™˜ê²½ ì„¤ì •:"
        echo "  NODE_OPTIONS: $NODE_OPTIONS"
        echo "  NODE_ENV: $NODE_ENV"
        echo "  NODE_POLYFILLS: $NODE_POLYFILLS"
        
        # ê°•í™”ëœ PDF ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        echo "ğŸ”„ ë©”ì¸ PDF ì²˜ë¦¬ ì‹œë„..."
        if node scripts/robust-pdf-preprocess.js; then
          echo "âœ… ë©”ì¸ PDF ì²˜ë¦¬ ì„±ê³µ!"
        else
          echo "âš ï¸ ë©”ì¸ PDF ì²˜ë¦¬ ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‹œë„..."
          node scripts/fallback-pdf-preprocess.js
          echo "âœ… ëŒ€ì²´ PDF ì²˜ë¦¬ ì™„ë£Œ!"
        fi
        
        echo "âœ… PDF ì²˜ë¦¬ ì™„ë£Œ!"
      env:
        VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
        
    - name: Validate processed data
      run: |
        echo "ğŸ” ì²˜ë¦¬ëœ ë°ì´í„° ê²€ì¦ ì¤‘..."
        
        if [ ! -f "public/data/processed-pdfs.json" ]; then
          echo "âŒ processed-pdfs.json íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        # JSON íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
        if ! jq empty public/data/processed-pdfs.json; then
          echo "âŒ processed-pdfs.jsonì´ ìœ íš¨í•œ JSONì´ ì•„ë‹™ë‹ˆë‹¤."
          exit 1
        fi
        
        # ë°ì´í„° í’ˆì§ˆ ê²€ì‚¬
        success_count=$(jq '.successfulFiles' public/data/processed-pdfs.json)
        total_count=$(jq '.totalFiles' public/data/processed-pdfs.json)
        failed_count=$(jq '.failedFiles' public/data/processed-pdfs.json)
        
        echo "ğŸ“Š ì²˜ë¦¬ ê²°ê³¼:"
        echo "  ì´ íŒŒì¼: $total_count"
        echo "  ì„±ê³µ: $success_count"
        echo "  ì‹¤íŒ¨: $failed_count"
        
        # ì‹¤íŒ¨ìœ¨ì´ 50% ì´ìƒì´ë©´ ì˜¤ë¥˜
        if [ "$failed_count" -gt 0 ] && [ "$((failed_count * 100 / total_count))" -gt 50 ]; then
          echo "âŒ ì‹¤íŒ¨ìœ¨ì´ 50%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤."
          exit 1
        fi
        
        # í•„ë¡œí‹° ê²€ìƒ‰ í…ŒìŠ¤íŠ¸
        if grep -q "í•„ë¡œí‹°" public/data/processed-pdfs.json; then
          echo "âœ… í•„ë¡œí‹° ê²€ìƒ‰ ê°€ëŠ¥ í™•ì¸"
        else
          echo "âš ï¸ ê²½ê³ : í•„ë¡œí‹° ê²€ìƒ‰ ë¶ˆê°€ëŠ¥"
        fi
        
        # ê°€ì§œ ë°ì´í„° ê²€ì‚¬
        if grep -q "ì œ1ì¡°(ëª©ì ) ì´ ë²•ë ¹ì€ êµ­ë¯¼ì˜ ê±´ê°•ì¦ì§„ì„ ìœ„í•œ ê¸ˆì—°ì‚¬ì—…ì˜ íš¨ìœ¨ì  ì¶”ì§„ì„ ìœ„í•˜ì—¬" public/data/processed-pdfs.json; then
          echo "âŒ ê°€ì§œ ë°ì´í„° ê°ì§€!"
          exit 1
        else
          echo "âœ… ê°€ì§œ ë°ì´í„° ì—†ìŒ"
        fi
        
    - name: Run data validation script
      run: |
        echo "ğŸ” ë°ì´í„° í’ˆì§ˆ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
        node scripts/validate-processed-data.js
        
    - name: Check for changes
      id: changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        fi
        
    - name: Commit and push changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add public/data/processed-pdfs.json
        git add dist/data/processed-pdfs.json
        git commit -m "Update processed-pdfs.json with robust processing [skip ci]

        - ì²­í¬ í¬ê¸°: ${{ github.event.inputs.chunkSize || 2000 }}ì
        - ì˜¤ë²„ë© í¬ê¸°: ${{ github.event.inputs.overlapSize || 200 }}ì
        - ì²˜ë¦¬ ì‹œê°„: $(date)
        - í™˜ê²½: GitHub Actions
        - í’ˆì§ˆ ê°œì„ : ê°€ì§œ ë°ì´í„° ì°¨ë‹¨, ëª¨ë“  ë‹¨ì–´ ê²€ìƒ‰ ê°€ëŠ¥"
        git push
        
    - name: Build and deploy
      if: steps.changes.outputs.changes == 'true'
      run: |
        echo "ğŸ—ï¸ ë¹Œë“œ ì‹œì‘..."
        npm run build
        echo "âœ… ë¹Œë“œ ì™„ë£Œ!"
      env:
        VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}
        
    - name: Setup Pages
      if: steps.changes.outputs.changes == 'true'
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      if: steps.changes.outputs.changes == 'true'
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist
        
    - name: Deploy to GitHub Pages
      if: steps.changes.outputs.changes == 'true'
      uses: actions/deploy-pages@v4
      
    - name: Notify completion
      run: |
        echo "ğŸ‰ ê°•í™”ëœ PDF ì²˜ë¦¬ ì™„ë£Œ!"
        echo "ğŸ“Š ì²˜ë¦¬ ê²°ê³¼:"
        echo "  ì„±ê³µ: $(jq '.successfulFiles' public/data/processed-pdfs.json)ê°œ"
        echo "  ì‹¤íŒ¨: $(jq '.failedFiles' public/data/processed-pdfs.json)ê°œ"
        echo "  ë³€ê²½ì‚¬í•­: ${{ steps.changes.outputs.changes }}"
        echo "  í•„ë¡œí‹° ê²€ìƒ‰: $(grep -q "í•„ë¡œí‹°" public/data/processed-pdfs.json && echo "ê°€ëŠ¥" || echo "ë¶ˆê°€ëŠ¥")"
        echo "  ê°€ì§œ ë°ì´í„°: $(grep -q "ì œ1ì¡°(ëª©ì ) ì´ ë²•ë ¹ì€ êµ­ë¯¼ì˜ ê±´ê°•ì¦ì§„ì„ ìœ„í•œ ê¸ˆì—°ì‚¬ì—…ì˜ íš¨ìœ¨ì  ì¶”ì§„ì„ ìœ„í•˜ì—¬" public/data/processed-pdfs.json && echo "ê°ì§€ë¨" || echo "ì—†ìŒ")"
